#!/bin/sh
#
# Pre-commit hook to prevent committing sensitive files
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Files to check
SENSITIVE_PATTERNS="\.env|\.local|\.pem|\.key|secret|password|credential"

# Get list of files to be committed
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check each staged file
for FILE in $STAGED_FILES; do
    # Check if file matches sensitive patterns
    if echo "$FILE" | grep -qiE "$SENSITIVE_PATTERNS"; then
        echo "${RED}❌ ERROR: Attempting to commit sensitive file: $FILE${NC}"
        echo "${YELLOW}⚠️  Files matching .env*, .local, .pem, .key, secret, password, or credential patterns cannot be committed.${NC}"
        echo "${YELLOW}   Please remove this file from staging: git reset HEAD $FILE${NC}"
        exit 1
    fi
    
    # Check file contents for obvious secrets
    if git diff --cached "$FILE" | grep -qiE "(api[_-]?key|secret|password|token)\s*=\s*['\"][a-zA-Z0-9]{20,}"; then
        echo "${RED}❌ ERROR: File '$FILE' appears to contain hardcoded secrets!${NC}"
        echo "${YELLOW}⚠️  Please use environment variables instead.${NC}"
        exit 1
    fi
done

echo "${GREEN}✓ Pre-commit checks passed${NC}"
exit 0

